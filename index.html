<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preventivatore 3D - Interno</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; padding:30px; color:#333; }
    .container { max-width:850px; background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08); margin: 0 auto; }
    
    h1 { margin:0 0 5px 0; color:#1a1a1a; }
    h2 { margin:25px 0 15px 0; font-size:18px; color:#0078d4; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
    
    label { display:block; margin-top:12px; font-weight:600; font-size: 14px; color:#444; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; transition: border 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #0078d4; outline: none; }
    
    .row { display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items: end; }
    @media (max-width:760px){ .row{grid-template-columns:1fr; gap: 0;} }
    
    .btn-group { display: flex; gap: 10px; margin-top: 25px; }
    button { padding:12px; flex:1; font-size:16px; font-weight: bold; color:white; border:none; border-radius:6px; cursor:pointer; transition: opacity 0.2s; }
    button:hover{ opacity: 0.9; }
    
    #btnOttimizza { background:#2e7d32; }
    #btnPdf { background:#d32f2f; }
    
    .result { margin-top:30px; padding:25px; background:#fff; border-radius:8px; border:1px solid #e1e4e8; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .muted { color:#666; font-size:13px; margin-top:5px; line-height: 1.4; }
    
    details { margin-top:20px; padding:15px; border:1px solid #e1e4e8; border-radius:8px; background:#fafbfc; }
    summary { font-weight:bold; cursor:pointer; color: #0078d4; }
    
    /* Stili preventivo */
    .preventivo-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    table.prev-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table.prev-table td { padding: 6px 0; border-bottom: 1px solid #f5f5f5; }
    table.prev-table tr:last-child td { border-bottom: none; }
    
    .total-block { background:#f9f9f9; padding:15px; border-radius:8px; margin-top:15px; text-align:right; border-left: 5px solid #ccc; }
    .totale-grande { font-size:26px; font-weight:bold; color: #333; margin-top:5px; }

    /* Evidenziazione campi calcolati automaticamente */
    .auto-calculated { background-color: #e8f5e9; border-color: #4caf50; }

    @media print {
      body { background: #fff; padding: 0; margin: 0; font-family: 'Times New Roman', serif; }
      .container { max-width: none; padding: 0; margin: 0; box-shadow: none; border: none; }
      .container > *:not(#risultato) { display: none !important; }
      #risultato { margin: 0; padding: 0; display: block !important; }
      .preventivo-header { margin-bottom: 30px; }
      .total-block { background: none; border: 1px solid #000; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Calcolatore Interno Stampa 3D</h1>
  <div class="muted">Strumento operativo per preventivazione rapida.</div>

  <details>
    <summary>‚öôÔ∏è Parametri Macchina & Costi Orari</summary>
    <div class="row">
      <div><label>Ore di stampa/giorno</label><input id="oreGiorno" type="number" value="22" min="1" step="0.1"></div>
      <div><label>Costo postprocesso ‚Ç¨/h</label><input id="costoPostOra" type="number" value="50" min="0" step="0.1"></div>
    </div>
    <div class="row">
      <div><label>Costo giorno (1)</label><input id="costoG1" type="number" value="60" min="0" step="0.1"></div>
      <div><label>Costo giorno (2‚Äì3)</label><input id="costoG3" type="number" value="48" min="0" step="0.1"></div>
    </div>
    <div class="row">
      <div><label>Costo giorno (4‚Äì7)</label><input id="costoG7" type="number" value="38" min="0" step="0.1"></div>
      <div><label>Costo giorno (‚â•8)</label><input id="costoG8" type="number" value="30" min="0" step="0.1"></div>
    </div>
  </details>

  <h2>1. Dati Commessa</h2>
  <div class="row">
    <div><label>Numero preventivo</label><input id="numeroPreventivo" type="text" placeholder="Es. 25-0001"></div>
    <div><label>Codice / Nome parte</label><input id="codiceParte" type="text" placeholder="Es. Coperchio_XYZ"></div>
  </div>
  <div class="row">
    <div><label>Materiale</label><input id="materialeParte" type="text" placeholder="Es. Nylon 12 CF"></div>
    <div><label>Colore</label><input id="coloreParte" type="text" placeholder="Es. Nero Opaco"></div>
  </div>

  <h2>2. Quantit√† e Tempi</h2>
  <div class="row">
    <div><label>Pezzi totali</label><input id="pezziTotali" type="number" value="100" min="1"></div>
    <div><label>Giorni macchina (Totali)</label><input id="giorniTotali" type="number" value="5" min="0.01" step="0.01"></div>
  </div>
  <div class="row">
    <div><label>Pezzi per batch</label><input id="pezziPerBatch" type="number" value="20" min="1"></div>
    <div><label>Ore per batch</label><input id="oreBatch" type="number" value="12" min="0" step="0.1"></div>
  </div>
  <div class="row">
    <div><label>Giorni consegna</label><input id="giorniConsegna" type="number" value="10" min="1"></div>
    <div><label>Postprocesso min/pezzo</label><input id="postMin" type="number" value="2" min="0" step="0.1"></div>
  </div>

  <h2>3. Consumo Materiali</h2>
  <div class="row"><div><label>Materiale 1</label><select id="mat1"></select></div><div><label>Metri/Batch (Mat 1)</label><input id="mat1_m" type="number" value="0" min="0" step="0.01"></div></div>
  <div class="row"><div><label>Materiale 2</label><select id="mat2"></select></div><div><label>Metri/Batch (Mat 2)</label><input id="mat2_m" type="number" value="0" min="0" step="0.01"></div></div>
  
  <details>
    <summary>‚ûï Altri materiali</summary>
    <div class="row"><div><label>Materiale 3</label><select id="mat3"></select></div><div><label>Metri/Batch (Mat 3)</label><input id="mat3_m" type="number" value="0" min="0" step="0.01"></div></div>
    <div class="row"><div><label>Materiale 4</label><select id="mat4"></select></div><div><label>Metri/Batch (Mat 4)</label><input id="mat4_m" type="number" value="0" min="0" step="0.01"></div></div>
  </details>

  <h2>4. Definizione Prezzo (Forzatura Target)</h2>
  <div class="row" style="background: #e3f2fd; padding:15px; border-radius:8px; border:1px solid #bbdefb;">
    <div>
        <label>üéØ Target Price (‚Ç¨/pezzo)</label>
        <input id="prezzoTargetParte" type="number" placeholder="Inserisci per calcolare sconto..." step="0.01">
        <div class="small muted">Scrivi qui per calcolare lo sconto al contrario.</div>
    </div>
    <div>
        <label>Sconto applicato (%)</label>
        <input id="scontoPerc" type="number" value="0" step="0.1">
        <div class="small muted">Viene aggiornato se imposti un Target.</div>
    </div>
  </div>

  <div class="btn-group">
    <button id="btnOttimizza">‚ö° Ottimizza Giorni</button>
    <button id="btnPdf">üìÑ Esporta PDF</button>
  </div>

  <h2>üìù Note</h2>
  <textarea id="note" style="width:100%;min-height:80px;" placeholder="Note..."></textarea>

  <div id="consuntivoTempi" class="result" style="background:#f9fbff; border-color:#d9e6ff;"></div>
  <div id="risultato" class="result"></div>
</div>

<script>
  const el = (id) => document.getElementById(id);
  // Selezioniamo tutti gli input tranne il target price (che ha una logica dedicata)
  const inputsGeneric = document.querySelectorAll('input:not(#prezzoTargetParte), select, textarea');

  const CONFIG = {
    LOGO_URL: 'assets/logo.png', // LOGO RIPRISTINATO
    AZIENDA: '3DMV Makers',
    EMAIL: '3dmv.makers@gmail.com',
    FALLBACK_MATERIALS: [
        { id: 'PLA_GEN', nome: 'PLA Generico', costoMetri: 0.06 },
        { id: 'PETG_GEN', nome: 'PETG Generico', costoMetri: 0.07 },
        { id: 'NYLON_12', nome: 'Nylon PA12', costoMetri: 0.25 },
        { id: 'TPU_95', nome: 'TPU 95A', costoMetri: 0.12 }
    ]
  };

  let MATERIALI = [];
  let MATERIALI_BY_ID = {};

  const parseNumberLoose = (v) => {
    const s = String(v ?? '').trim().replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  };

  const escapeHtml = (str) => String(str).replace(/[&<>"']/g, function(m) {
    return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m];
  });

  const fmtMoney = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
  const fmtNum = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });

  // --- STORAGE ---
  function saveState() {
    const data = {};
    document.querySelectorAll('input, select, textarea').forEach(i => {
        if(i.id) data[i.id] = i.value;
    });
    localStorage.setItem('3d_calc_internal_v2', JSON.stringify(data));
  }

  function loadState() {
    const saved = localStorage.getItem('3d_calc_internal_v2');
    if (!saved) return;
    try {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(k => {
            const field = el(k);
            if (field) field.value = data[k];
        });
    } catch(e) { console.error(e); }
  }

  // --- LOGICA BUSINESS ---
  function costoGiorno(g) {
    if (g <= 1) return parseNumberLoose(el('costoG1').value);
    if (g <= 3) return parseNumberLoose(el('costoG3').value);
    if (g <= 7) return parseNumberLoose(el('costoG7').value);
    return parseNumberLoose(el('costoG8').value);
  }

  // Funzione pura che calcola solo i costi LORDI (senza sconto)
  function getDatiLordi() {
    const p = parseNumberLoose(el('pezziTotali').value);
    const g = parseNumberLoose(el('giorniTotali').value);
    const pb = parseNumberLoose(el('pezziPerBatch').value);
    const post = parseNumberLoose(el('postMin').value);
    const cPost = parseNumberLoose(el('costoPostOra').value);

    if (p <= 0 || g <= 0 || pb <= 0) return null;

    const batch = Math.ceil(p / pb);
    let costoMaterialeBase = 0;
    let metriLotto = 0;

    for (let i = 1; i <= 4; i++) {
      const m = parseNumberLoose(el(`mat${i}_m`).value);
      const matId = el(`mat${i}`).value;
      const rec = matId ? MATERIALI_BY_ID[matId] : null;
      if (rec && m > 0) {
         metriLotto += (m * batch); 
         costoMaterialeBase += (m * rec.costoMetri * batch);
      }
    }

    const costoStampa = g * costoGiorno(g);
    const costoPost = (p * post / 60) * cPost;
    const MARKUP_MAT = 1.0; 
    const costoMaterialeFinale = costoMaterialeBase * MARKUP_MAT;
    const totaleLordo = costoStampa + costoPost + costoMaterialeFinale;

    return {
        p, g, pb, batch, metriLotto,
        costoStampa, costoPost, costoMaterialeFinale,
        totaleLordo
    };
  }

  // 1. Calcolo avviato dai cambi generici
  function calcolaStandard() {
    saveState();
    renderPreventivo();
  }

  // 2. Calcolo inverso avviato SOLO dal campo Target Price
  function calcolaDaTarget() {
    const dati = getDatiLordi();
    const targetPrice = parseNumberLoose(el('prezzoTargetParte').value);

    if (dati && dati.totaleLordo > 0 && targetPrice > 0) {
        // Logica inversa:
        // TotaleTarget = TargetUnitario * Pezzi
        // Sconto% = 100 - (TotaleTarget / TotaleLordo * 100)
        
        const totaleTarget = targetPrice * dati.p;
        let newSconto = 100 - ((totaleTarget / dati.totaleLordo) * 100);
        
        // Arrotondiamo a 2 decimali
        el('scontoPerc').value = newSconto.toFixed(2);
        
        // Evidenziazione visuale per far capire che √® successo qualcosa
        el('scontoPerc').classList.add('auto-calculated');
        setTimeout(() => el('scontoPerc').classList.remove('auto-calculated'), 1000);
    }
    
    saveState();
    renderPreventivo();
  }

  function renderPreventivo() {
    const dati = getDatiLordi();
    if (!dati) {
      el('risultato').innerHTML = '<p class="muted" style="text-align:center">Compila i dati per vedere il preventivo.</p>';
      el('consuntivoTempi').style.display = 'none';
      return;
    }
    el('consuntivoTempi').style.display = 'block';

    const sconto = parseNumberLoose(el('scontoPerc').value);
    const importoSconto = dati.totaleLordo * (sconto / 100);
    const totaleNetto = dati.totaleLordo - importoSconto;
    const costoPezzo = totaleNetto / dati.p;

    // Render HTML Tempi
    el('consuntivoTempi').innerHTML = `
      <h3 style="margin-top:0">‚è±Ô∏è Analisi Tempi</h3>
      <div class="row" style="gap:10px;">
        <div>Batch totali: <strong>${dati.batch}</strong></div>
        <div>Ore totali prod.: <strong>${fmtNum.format(dati.batch * parseNumberLoose(el('oreBatch').value))} h</strong></div>
        <div>Metri filo tot.: <strong>${fmtNum.format(dati.metriLotto)} m</strong></div>
        <div>Efficienza: <strong>${ (((dati.batch * parseNumberLoose(el('oreBatch').value)) / (dati.g * parseNumberLoose(el('oreGiorno').value))) * 100).toFixed(0) }%</strong></div>
      </div>
    `;

    const dataOggi = new Date().toLocaleDateString('it-IT');
    const noteRaw = el('note').value || '';
    
    el('risultato').innerHTML = `
      <div class="preventivo-header">
         <div>
            ${CONFIG.LOGO_URL ? `<img src="${CONFIG.LOGO_URL}" style="height:60px; margin-bottom:10px; object-fit:contain;"><br>` : ''}
            <div style="font-size:24px; font-weight:bold; color:#0078d4">PREVENTIVO</div>
            <div class="muted">Rif: <strong>${escapeHtml(el('numeroPreventivo').value || 'Interno')}</strong> del ${dataOggi}</div>
         </div>
         <div style="text-align:right">
            <strong>${CONFIG.AZIENDA}</strong><br>
            <span class="muted">${CONFIG.EMAIL}</span>
         </div>
      </div>

      <div class="preventivo-box">
        <strong>Dettaglio Articolo</strong>
        <table class="prev-table">
            <tr><td>Parte:</td><td>${escapeHtml(el('codiceParte').value || '-')}</td></tr>
            <tr><td>Materiale:</td><td>${escapeHtml(el('materialeParte').value || '-')}</td></tr>
            <tr><td>Quantit√†:</td><td><strong>${dati.p} pz</strong></td></tr>
            <tr><td>Consegna:</td><td>${el('giorniConsegna').value} gg lavorativi</td></tr>
        </table>
      </div>

      <div class="preventivo-box">
        <strong>Dettaglio Costi</strong>
        <table class="prev-table">
            <tr><td>Stampa (${dati.g}gg):</td><td align="right">${fmtMoney.format(dati.costoStampa)}</td></tr>
            <tr><td>Materiale:</td><td align="right">${fmtMoney.format(dati.costoMaterialeFinale)}</td></tr>
            <tr><td>Post-processo:</td><td align="right">${fmtMoney.format(dati.costoPost)}</td></tr>
            <tr style="font-weight:bold; background:#f5f5f5;">
                <td>Totale Lordo</td><td align="right">${fmtMoney.format(dati.totaleLordo)}</td>
            </tr>
            ${sconto !== 0 ? `
            <tr style="color:${sconto > 0 ? '#d32f2f' : '#2e7d32'};">
                <td>${sconto > 0 ? 'Sconto' : 'Ricarico'} (${sconto.toFixed(2)}%)</td><td align="right">${sconto > 0 ? '-' : '+'} ${fmtMoney.format(Math.abs(importoSconto))}</td>
            </tr>` : ''}
        </table>
      </div>

      <div class="total-block">
         <div class="muted">Prezzo unitario netto</div>
         <div style="font-size:18px;">${fmtMoney.format(costoPezzo)} / pz</div>
         <div style="margin:10px 0; border-top:1px solid #ddd;"></div>
         <div class="muted">TOTALE COMMESSA</div>
         <div class="totale-grande">${fmtMoney.format(totaleNetto)}</div>
      </div>

      ${noteRaw ? `<div style="margin-top:20px; padding:10px; border:1px solid #eee; border-radius:6px;"><small><strong>NOTE:</strong><br>${escapeHtml(noteRaw).replaceAll('\n','<br>')}</small></div>` : ''}
    `;
  }

  function ottimizzaTempi() {
    const p = parseNumberLoose(el('pezziTotali').value);
    const pb = parseNumberLoose(el('pezziPerBatch').value);
    const oreB = parseNumberLoose(el('oreBatch').value);
    const oreG = parseNumberLoose(el('oreGiorno').value);

    if (p > 0 && pb > 0 && oreG > 0) {
       el('giorniTotali').value = (Math.ceil(p / pb) * oreB / oreG).toFixed(2);
       el('giorniTotali').dispatchEvent(new Event('input'));
    } else {
       alert("Inserisci Pezzi, Batch e Ore per calcolare i giorni minimi.");
    }
  }

  async function init() {
    try {
        const res = await fetch('materiali.csv');
        if (!res.ok) throw new Error('File non trovato');
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(x => x.trim());
        const headers = lines[0].split(',').map(h => h.toLowerCase().trim());
        
        const idx = (n) => headers.findIndex(h => h.includes(n));
        const iId = idx('id'); const iNome = idx('nome'); const iCostoM = idx('costo-metri');

        if(iId < 0 || iCostoM < 0) throw new Error("CSV colonne mancanti");

        MATERIALI = lines.slice(1).map(line => {
             const c = line.split(',');
             return { id: c[iId], nome: c[iNome]||c[iId], costoMetri: parseNumberLoose(c[iCostoM]) };
        }).filter(x => x.id);

    } catch (e) {
        console.warn("Uso materiali fallback");
        MATERIALI = CONFIG.FALLBACK_MATERIALS;
    }

    MATERIALI.forEach(m => MATERIALI_BY_ID[m.id] = m);

    for (let i = 1; i <= 4; i++) {
        const sel = el(`mat${i}`);
        sel.innerHTML = '<option value="">-- Seleziona --</option>';
        MATERIALI.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = `${m.nome} (‚Ç¨${m.costoMetri.toFixed(2)}/m)`;
            sel.appendChild(opt);
        });
    }

    loadState();
    
    // Listener differenziati
    inputsGeneric.forEach(inp => inp.addEventListener('input', calcolaStandard));
    el('prezzoTargetParte').addEventListener('input', calcolaDaTarget);
    
    el('btnOttimizza').addEventListener('click', ottimizzaTempi);
    el('btnPdf').addEventListener('click', () => window.print());

    calcolaStandard();
  }

  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>