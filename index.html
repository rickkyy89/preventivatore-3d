<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcolatore Prezzo Stampa 3D</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:30px; }
    .container { max-width:760px; background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    h1 { margin:0 0 12px 0; }
    h2 { margin:18px 0 10px 0; font-size:18px; }
    label { display:block; margin-top:14px; font-weight:bold; }
    input, select, textarea { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:760px){ .row{grid-template-columns:1fr;} }
    button { margin-top:20px; padding:12px; width:100%; font-size:16px; background:#0078d4; color:white; border:none; border-radius:6px; cursor:pointer; }
    button:hover{ background:#005fa3; }
    .result { margin-top:22px; padding:20px; background:#ffffff; border-radius:6px; border:1px solid #d9e6ff; }
    .muted { color:#3a3a3a; font-size:13px; margin-top:8px; }
    .small { font-size:12px; }
    details { margin-top:14px; padding:10px; border:1px solid #d9e6ff; border-radius:6px; background:#f9fbff; }
    summary { font-weight:bold; cursor:pointer; }
    .highlight { background:#fff3cd; padding:8px; border-radius:6px; }
    .preventivo-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:12px; }
    .preventivo-box { border:1px solid #d9e6ff; padding:12px; border-radius:6px; margin-top:10px; }
    .totale { font-size:20px; font-weight:bold; }

    @media print {

    body {
        background: #fff;
        padding: 0;
        margin: 0;
    }

    .container {
        max-width: none;
        padding: 0;
        margin: 0;
        box-shadow: none;
        border-radius: 0;
    }

    /* Nasconde tutto tranne il preventivo */
    .container > *:not(#risultato) {
        display: none !important;
    }

    #risultato {
        margin: 10mm;
        padding: 0;
        border: none;
    }

    .preventivo-box {
        page-break-inside: avoid;
    }

    .preventivo-header {
        margin-bottom: 12px;
    }
    }

    </style>
</head>
<body>
<div class="container">
  <h1>Calcolatore prezzo stampa 3D</h1>

  <div class="muted">Modello: prezzo a <strong>giorno macchina</strong> + materiale reale (metri/batch) + postprocesso, con sconti espliciti.</div>

  <details>
    <summary>‚öôÔ∏è Parametri di controllo</summary>
    <div class="row">
      <div><label>Ore di stampa/giorno</label><input id="oreGiorno" type="number" value="22" min="1" step="0.1"></div>
      <div><label>Costo postprocesso ‚Ç¨/h</label><input id="costoPostOra" type="number" value="50" min="0" step="0.1"></div>
    </div>
    <div class="row">
      <div><label>Costo giorno (1)</label><input id="costoG1" type="number" value="60" min="0" step="0.1"></div>
      <div><label>Costo giorno (2‚Äì3)</label><input id="costoG3" type="number" value="48" min="0" step="0.1"></div>
    </div>
    <div class="row">
      <div><label>Costo giorno (4‚Äì7)</label><input id="costoG7" type="number" value="38" min="0" step="0.1"></div>
      <div><label>Costo giorno (‚â•8)</label><input id="costoG8" type="number" value="30" min="0" step="0.1"></div>
    </div>
  </details>

  <h2>Dati commessa</h2>
  <div class="row">
    <div>
        <label>Numero preventivo</label>
        <input id="numeroPreventivo" type="text" placeholder="Es. 25-0001">
    </div>
    <div></div>
  </div>
  <div class="row">
    <div><label>Codice / Nome parte</label><input id="codiceParte" type="text" placeholder="Es. Coperchio_XYZ"></div>
    <div><label>Materiale / Tipologia</label><input id="materialeParte" type="text" placeholder="Es. Nylon 12"></div>
  </div>
  <div class="row">
    <div><label>Colore</label><input id="coloreParte" type="text" placeholder="Es. Nero"></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>Pezzi totali</label><input id="pezziTotali" type="number" value="300" min="1"></div>
    <div><label>Giorni macchina</label><input id="giorniTotali" type="number" value="15" min="0.01" step="0.01"></div>
  </div>
  <div class="row">
    <div><label>Giorni lavorativi di consegna</label><input id="giorniConsegna" type="number" value="15" min="1"></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>Pezzi per batch</label><input id="pezziPerBatch" type="number" value="20" min="1"></div>
    <div><label>Ore batch</label><input id="oreBatch" type="number" value="17" min="0" step="0.1"></div>
  </div>
  <div class="row">
    <div><label>Postprocesso min/pezzo</label><input id="postMin" type="number" value="2" min="0" step="0.1"></div>
    <div></div>
  </div>

  <h2>Gestione materiali (fino a 4 per batch)</h2>
  <div class="row"><div><label>Materiale 1</label><select id="mat1"></select></div><div><label>Metri/batch</label><input id="mat1_m" type="number" value="0" min="0" step="0.01"></div></div>
  <div class="row"><div><label>Materiale 2</label><select id="mat2"></select></div><div><label>Metri/batch</label><input id="mat2_m" type="number" value="0" min="0" step="0.01"></div></div>
  <div class="row"><div><label>Materiale 3</label><select id="mat3"></select></div><div><label>Metri/batch</label><input id="mat3_m" type="number" value="0" min="0" step="0.01"></div></div>
  <div class="row"><div><label>Materiale 4</label><select id="mat4"></select></div><div><label>Metri/batch</label><input id="mat4_m" type="number" value="0" min="0" step="0.01"></div></div>

  <details>
    <summary>üí∏ Sconti e target</summary>
    <div class="row">
      <div><label>Sconto %</label><input id="scontoPerc" type="number" value="0" min="0" max="100" step="0.1"></div>
      <div><label>Prezzo target ‚Ç¨/pezzo</label><input id="prezzoTargetParte" type="number" value="0" min="0" step="0.01"></div>
    </div>
  </details>

  <button id="btnCalcola">Calcola prezzo</button>
  <button id="btnOttimizza" style="background:#2e7d32;margin-top:10px;">‚ö° Ottimizza tempi</button>
  <button onclick="stampaPdf()">üìÑ Esporta PDF</button>


  <h2>üìù Note</h2>
  <textarea id="note" style="width:100%;min-height:90px;" placeholder="Inserisci qui eventuali note..."></textarea>

  <div id="consuntivoTempi" class="result"></div>
  <div id="risultato" class="result"></div>
</div>

<script>
  const el = (id) => document.getElementById(id);

  const CONFIG = {
  LOGO_URL: 'assets/logo.png',   // percorso relativo
  AZIENDA: '3DMV Makers',
  EMAIL: '3dmv.makers@gmail.com'
  };

  let LOGO_URL = '';

  let MATERIALI = [];          // array di record
  let MATERIALI_BY_ID = {};    // lookup veloce per id

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

function parseNumberLoose(v) {
  // accetta sia "0.18" che "0,18"
  const s = String(v ?? '').trim().replace(',', '.');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}

function dataOggiIT() {
  return new Date().toLocaleDateString('it-IT');
}

function stampaPdf() {
  window.print();
}

async function caricaMaterialiCSV() {
  const res = await fetch('materiali.csv', { cache: 'no-store' });
  if (!res.ok) throw new Error('Impossibile caricare materiali.csv');

  const text = await res.text();
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (lines.length < 2) throw new Error('materiali.csv vuoto o incompleto');

  const headers = lines[0].split(',').map(h => h.trim()); // trim robusto
  const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx('id');
  const iNome = idx('nome');
  const iCosto = idx('costo');
  const iCostoMetri = idx('costo-metri');
  const iPeso = idx('peso');
  const iMetri = idx('metri');
  const iDensita = idx('densit√†');

  if (iId === -1 || iNome === -1 || iCostoMetri === -1) {
    throw new Error('Header CSV non valido: servono almeno id, nome, costo-metri');
  }

  MATERIALI = [];
  MATERIALI_BY_ID = {};

  for (let r = 1; r < lines.length; r++) {
    const cols = lines[r].split(',').map(c => c.trim());
    const rec = {
      id: cols[iId] || '',
      nome: cols[iNome] || '',
      costo: iCosto !== -1 ? parseNumberLoose(cols[iCosto]) : 0,
      costoMetri: parseNumberLoose(cols[iCostoMetri]),
      peso: iPeso !== -1 ? parseNumberLoose(cols[iPeso]) : 0,
      metri: iMetri !== -1 ? parseNumberLoose(cols[iMetri]) : 0,
      densita: iDensita !== -1 ? parseNumberLoose(cols[iDensita]) : 0
    };

    if (!rec.id) continue;
    MATERIALI.push(rec);
    MATERIALI_BY_ID[rec.id] = rec;
  }

  // opzionale: ordina per nome
  MATERIALI.sort((a, b) => a.nome.localeCompare(b.nome, 'it'));
}


  function popolaMateriali() {
  for (let i = 1; i <= 4; i++) {
    const s = el(`mat${i}`);
    s.innerHTML = '<option value="">‚Äî</option>';

    MATERIALI.forEach((m) => {
      const o = document.createElement('option');
      o.value = m.id; // IMPORTANT: ora il value √® l'id
      o.textContent = `${m.nome} (‚Ç¨${m.costoMetri.toFixed(3)}/m)`;
      s.appendChild(o);
    });
  }
}


  function costoGiorno(g) {
    if (g === 1) return +el('costoG1').value;
    if (g <= 3) return +el('costoG3').value;
    if (g <= 7) return +el('costoG7').value;
    return +el('costoG8').value;
  }

  function calcola() {
    const p = +el('pezziTotali').value;
    const g = +el('giorniTotali').value;
    const pb = +el('pezziPerBatch').value;
    const post = +el('postMin').value;
    const cPost = +el('costoPostOra').value;

    if (!isFinite(p) || p <= 0 || !isFinite(g) || g <= 0 || !isFinite(pb) || pb <= 0) {
      el('consuntivoTempi').innerHTML = '';
      el('risultato').innerHTML = '<p class="highlight"><strong>Errore:</strong> controlla i dati inseriti.</p>';
      return;
    }

    const batch = Math.ceil(p / pb);
    let costoBatch = 0;
    let metriBatch = 0;

    for (let i = 1; i <= 4; i++) {
      const m = +el(`mat${i}_m`).value;
      const matId = el(`mat${i}`).value;
      const rec = matId ? MATERIALI_BY_ID[matId] : null;

      if (rec && isFinite(m) && m > 0) {
         metriBatch += m;
         costoBatch += m * rec.costoMetri; // ‚Ç¨/m
        }
    }

    const metriLotto = metriBatch * batch;
    const costoMateriale = costoBatch * batch;
    const costoStampa = g * costoGiorno(g);
    const costoPost = (p * post / 60) * cPost;

    const totaleLordo = costoStampa + costoPost + costoMateriale;

    el('consuntivoTempi').innerHTML = `
      <h2>‚è±Ô∏è Consuntivo tempi</h2>
      <p><strong>Batch totali:</strong> ${batch}</p>
      <p><strong>Ore batch:</strong> ${(+el('oreBatch').value).toFixed(2)} h</p>
      <p><strong>Ore totali produttive:</strong> ${(batch * +el('oreBatch').value).toFixed(1)} h</p>
      <p><strong>Ore disponibili:</strong> ${(g * +el('oreGiorno').value).toFixed(1)} h</p>
      <p><strong>Produttivit√†:</strong> ${(((batch * +el('oreBatch').value) / (g * +el('oreGiorno').value)) * 100).toFixed(1)} %</p>
      <p><strong>Ore morte:</strong> ${Math.max((g * +el('oreGiorno').value) - (batch * +el('oreBatch').value), 0).toFixed(1)} h</p>
      <p><strong>Metri totali filo:</strong> ${metriLotto.toFixed(1)} m</p>
    `;

    const giorniConsegna = (+el('giorniConsegna').value || 0);
    const noteRaw = el('note').value || '';
    const noteHtml = escapeHtml(noteRaw).replaceAll('\n', '<br>');

    el('risultato').innerHTML = `
        <div class="preventivo-header">
            ${CONFIG.LOGO_URL
                ? `<img src="${CONFIG.LOGO_URL}" alt="Logo" style="height:70px;object-fit:contain;" />`
                : ''
            }
            <div style="text-align:right">
                <strong>PREVENTIVO STAMPA 3D</strong><br>

                ${el('numeroPreventivo').value
                    ? `<span class="muted">Preventivo n¬∞ <strong>${escapeHtml(el('numeroPreventivo').value)}</strong></span><br>`
                    : ''
                }

                <span class="muted">Data: ${dataOggiIT()}</span><br>
                <span class="muted">${CONFIG.AZIENDA}</span><br>
                <span class="muted">${CONFIG.EMAIL}</span>
            </div>

        </div>

      <div class="preventivo-box">
        <p><strong>Parte:</strong> ${escapeHtml(el('codiceParte').value || '-') }</p>
        <p><strong>Materiale:</strong> ${escapeHtml(el('materialeParte').value || '-') }</p>
        <p><strong>Colore:</strong> ${escapeHtml(el('coloreParte').value || '-') }</p>
        <hr />
        <p><strong>Quantit√†:</strong> ${p} pezzi</p>
        <p><strong>Giorni macchina:</strong> ${g.toFixed(2)}</p>
        <p><strong>Giorni lavorativi di consegna:</strong> ${giorniConsegna} giorni</p>
        <p class="muted small">* I giorni di consegna sono da intendersi dalla data di conferma dell‚Äôordine e/o dalla data di arrivo del materiale qualora non disponibile a stock.</p>
        <p><strong>Parti / giorno:</strong> ${(p / g).toFixed(1)}</p>
        <p><strong>Batch totali:</strong> ${batch}</p>
        <p><strong>Batch / giorno:</strong> ${(batch / g).toFixed(2)}</p>
        <p><strong>Metri totali di filo:</strong> ${metriLotto.toFixed(1)} m</p>
      </div>

      <div class="preventivo-box">
        <p><strong>Costi</strong></p>
        <p>Stampa: ‚Ç¨${costoStampa.toFixed(2)}</p>
        <p>Postprocesso: ‚Ç¨${costoPost.toFixed(2)}</p>
        <p>Materiale: ‚Ç¨${costoMateriale.toFixed(2)}</p>
      </div>

      <div class="preventivo-box">
        <p><strong>Prezzo senza sconto:</strong> ‚Ç¨${totaleLordo.toFixed(2)}</p>
        <p><strong>Costo per parte:</strong> ‚Ç¨${(totaleLordo / p).toFixed(2)}</p>
      </div>

      ${noteRaw.trim() ? `<div class="preventivo-box"><strong>Note:</strong><br>${noteHtml}</div>` : ''}
    `;
  }

  function ottimizzaTempi() {
    const p = +el('pezziTotali').value;
    const pb = +el('pezziPerBatch').value;
    const oreB = +el('oreBatch').value;
    const oreG = +el('oreGiorno').value;

    if (!isFinite(p) || p <= 0 || !isFinite(pb) || pb <= 0 || !isFinite(oreB) || oreB <= 0 || !isFinite(oreG) || oreG <= 0) {
      alert('Dati non validi per ottimizzare i tempi');
      return;
    }

    el('giorniTotali').value = (Math.ceil(p / pb) * oreB / oreG).toFixed(2);
    calcola();
  }

  function assert(cond, msg) {
    if (!cond) throw new Error('TEST FAIL: ' + msg);
  }

  function runTests() {
    assert(typeof MATERIALI === 'object' && MATERIALI !== null, 'MATERIALI deve essere un oggetto');
    assert(Object.keys(MATERIALI).length >= 1, 'MATERIALI deve avere almeno 1 elemento');

    el('pezziTotali').value = 300;
    el('giorniTotali').value = 15;
    el('pezziPerBatch').value = 20;
    el('mat1').value = 'PLA';
    el('mat1_m').value = 10;
    el('note').value = "Riga1\nRiga2";

    calcola();
    assert(el('risultato').innerHTML.includes('Riga1<br>Riga2'), 'Note devono mantenere a capo');
    assert(el('risultato').innerHTML.includes('Metri totali di filo'), 'Preventivo deve includere metri totali');
  }

  window.addEventListener('DOMContentLoaded', () => {
    caricaMaterialiCSV()
        .then(popolaMateriali)
        .catch((e) => {
            console.error(e);
            alert('Errore: materiali.csv non caricato o non valido.');
     });
    el('btnCalcola').addEventListener('click', calcola);
    el('btnOttimizza').addEventListener('click', ottimizzaTempi);
    el('btnPdf').addEventListener('click', exportPdf);

    calcola();
    try { runTests(); } catch (e) { console.error(e); }
  });
</script>
</body>
</html>
