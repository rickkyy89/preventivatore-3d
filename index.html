<script>
  const el = (id) => document.getElementById(id);
  const inputsGeneric = document.querySelectorAll('input:not(#numStampanti):not(#target3DMV):not(#targetSTR):not([readonly]), select, textarea');
  
  // VERSIONE APP E CHIAVE STORAGE
  const APP_VERSION = '0.17';
  const STORAGE_KEY = '3d_calc_int_v' + APP_VERSION.replace('.', '_');

  const CONFIG = {
    LOGO_URL: 'assets/logo.png',
    AZIENDA: '3DMV Makers',
    EMAIL: '3dmv.makers@gmail.com',
    FALLBACK_MATERIALS: [
        { id: 'PLA_GEN', nome: 'PLA Generico', costoMetri: 0.06 },
        { id: 'PETG_GEN', nome: 'PETG Generico', costoMetri: 0.07 },
        { id: 'NYLON_12', nome: 'Nylon PA12', costoMetri: 0.25 }
    ]
  };

  let MATERIALI = [];
  let MATERIALI_BY_ID = {};

  const parseNumberLoose = (v) => {
    const s = String(v ?? '').trim().replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  };

  const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','-':'&#45;','"' : '&quot;',"'" : '&#39;'})[m]);
  const fmtMoney = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
  const fmtNum = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });

  // --- FUNZIONE SAFE PER EVITARE CRASH ---
  // Se un input manca nell'HTML, non blocca lo script ma restituisce stringa vuota
  const safeVal = (id) => {
      const element = el(id);
      if (!element) {
          console.warn(`ATTENZIONE: Manca l'elemento HTML con id='${id}'. Verifica il codice HTML.`);
          return 'ERR_HTML'; 
      }
      return element.value;
  };

  // CONFIG CSV LOADER
  async function loadConfigDefaults() {
      try {
          const res = await fetch('config.csv');
          if (!res.ok) {
              console.log('Info: config.csv non trovato o errore 404. Uso default.');
              return; 
          }
          const text = await res.text();
          const lines = text.split(/\r?\n/);
          lines.forEach(line => {
             const parts = line.split(',');
             if(parts.length >= 2) {
                 const key = parts[0].trim();
                 const val = parts[1].trim();
                 const element = el(key);
                 if(element && !element.readOnly) {
                     element.value = val;
                 }
             }
          });
          ricalcolaGiorniAuto();
      } catch(e) { console.log('Errore caricamento config:', e); }
  }

  // STORAGE
  function saveState() {
    const data = {};
    document.querySelectorAll('input, select, textarea').forEach(i => {
        if(i.id && !i.readOnly) {
            if(i.type === 'checkbox') data[i.id] = i.checked;
            else data[i.id] = i.value;
        }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    try {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(k => {
            const field = el(k);
            if (field && !field.readOnly) {
                if(field.type === 'checkbox') field.checked = data[k];
                else field.value = data[k];
            }
        });
        toggleNoIvaBox();
    } catch(e) {}
  }

  function toggleNoIvaBox() {
      const isMatSTR = el('checkMatSTR').checked;
      el('boxNoIva').style.display = isMatSTR ? 'flex' : 'none';
      if(!isMatSTR) el('checkNoIvaMat').checked = false; 
  }

  function calcolaLogaritmica(inputVal, start, end, limit) {
    if (inputVal <= 1) return start;
    if (inputVal >= limit) return end;
    if (limit <= 1) return start;
    const delta = start - end;
    const factor = delta / Math.log(limit);
    return start - (factor * Math.log(inputVal));
  }

  function ricalcolaGiorniAuto() {
      const p = parseNumberLoose(safeVal('pezziTotali'));
      const pb = parseNumberLoose(safeVal('pezziPerBatch'));
      const oreB = parseNumberLoose(safeVal('oreBatch'));
      const oreG = parseNumberLoose(safeVal('oreGiorno'));
      const nStamp = parseNumberLoose(safeVal('numStampanti')) || 1;

      if (p > 0 && pb > 0 && oreG > 0) {
         const batchNecessari = Math.ceil(p / pb);
         const oreTotaliStampa = batchNecessari * oreB;
         const capacitaCluster = oreG * nStamp;
         const giorni = (oreTotaliStampa / capacitaCluster).toFixed(2);
         if(el('giorniTotali')) el('giorniTotali').value = giorni;
      }
      calcolaStandard(); 
  }

  function getDatiLordi() {
    const p = parseNumberLoose(safeVal('pezziTotali'));
    const g = parseNumberLoose(safeVal('giorniTotali'));
    const pb = parseNumberLoose(safeVal('pezziPerBatch'));
    const nStampanti = parseNumberLoose(safeVal('numStampanti')) || 1;
    
    // Parametri Post Processo
    const postMin3DMV = parseNumberLoose(safeVal('postMin3DMV'));
    const extraPezzo3DMV = parseNumberLoose(safeVal('extraPezzo3DMV'));
    const costoPostOra3DMV = parseNumberLoose(safeVal('costoPostOra3DMV'));

    const postMinSTR = parseNumberLoose(safeVal('postMinSTR'));
    const extraPezzoSTR = parseNumberLoose(safeVal('extraPezzoSTR'));
    const costoPostOraSTR = parseNumberLoose(safeVal('costoPostOraSTR'));

    const matMarkup = parseNumberLoose(safeVal('matMarkup')) || 1;
    const isMatSTR = el('checkMatSTR') ? el('checkMatSTR').checked : false;
    const isNoIvaMat = el('checkNoIvaMat') ? el('checkNoIvaMat').checked : false;
    
    // Parametri Tempo
    const orePerBatch = parseNumberLoose(safeVal('oreBatch'));
    const oreGiorno = parseNumberLoose(safeVal('oreGiorno'));

    if (p <= 0 || g <= 0 || pb <= 0) return null;

    const batchTotali = Math.ceil(p / pb);
    const oreTotaliVolume = batchTotali * orePerBatch; 
    const oreCalendario = g * oreGiorno;

    let costoMaterialeBase = 0;
    let metriLotto = 0;

    for (let i = 1; i <= 4; i++) {
      const m = parseNumberLoose(safeVal(`mat${i}_m`));
      const matId = safeVal(`mat${i}`);
      const rec = matId ? MATERIALI_BY_ID[matId] : null;
      if (rec && m > 0) {
         metriLotto += (m * batchTotali); 
         costoMaterialeBase += (m * rec.costoMetri * batchTotali);
      }
    }
    
    if (isMatSTR && isNoIvaMat) {
        costoMaterialeBase = costoMaterialeBase / 1.22;
    }

    const costoMaterialeFinale = costoMaterialeBase * matMarkup;
    
    // Post Processo
    const costoPost3DMV = (p * postMin3DMV / 60 * costoPostOra3DMV) + (p * extraPezzo3DMV);
    const costoPostSTR = (p * postMinSTR / 60 * costoPostOraSTR) + (p * extraPezzoSTR);

    // --- CALCOLO 3DMV ---
    const rateBase_M = calcolaLogaritmica(g, parseNumberLoose(safeVal('start3DMV_M')), parseNumberLoose(safeVal('end3DMV_M')), parseNumberLoose(safeVal('limit3DMV_M')));
    const rateCluster_M = rateBase_M * nStampanti;
    const costoMacchine_3DMV = rateCluster_M * g; 

    const rate_R = calcolaLogaritmica(oreCalendario, parseNumberLoose(safeVal('start3DMV_R')), parseNumberLoose(safeVal('end3DMV_R')), parseNumberLoose(safeVal('limit3DMV_R')));
    const costoRicavo_3DMV = rate_R * oreTotaliVolume;

    if(el('dispRate3DMV_M')) el('dispRate3DMV_M').value = fmtMoney.format(rateCluster_M);
    if(el('dispTotal3DMV_M')) el('dispTotal3DMV_M').value = fmtMoney.format(costoMacchine_3DMV);
    if(el('dispRate3DMV_R')) el('dispRate3DMV_R').value = fmtMoney.format(rate_R);
    if(el('dispTotal3DMV_R')) el('dispTotal3DMV_R').value = fmtMoney.format(costoRicavo_3DMV);

    // --- CALCOLO S.T.R. ---
    const rate_STR = calcolaLogaritmica(oreCalendario, parseNumberLoose(safeVal('startSTR')), parseNumberLoose(safeVal('endSTR')), parseNumberLoose(safeVal('limitSTR')));
    const costoService_STR = rate_STR * oreTotaliVolume;
    
    if(el('dispRateSTR')) el('dispRateSTR').value = fmtMoney.format(rate_STR);
    if(el('dispTotalSTR')) el('dispTotalSTR').value = fmtMoney.format(costoService_STR);

    // --- TOTALI LORDI ---
    let totale3DMV = costoMacchine_3DMV + costoRicavo_3DMV + costoPost3DMV;
    if (!isMatSTR) totale3DMV += costoMaterialeFinale;

    let totaleSTR = costoService_STR + costoPostSTR;
    if (isMatSTR) totaleSTR += costoMaterialeFinale;

    return { 
        p, g, pb, batch: batchTotali, metriLotto, nStampanti, oreCalendario, oreTotaliVolume,
        costoMacchine_3DMV, costoRicavo_3DMV, 
        costoPost3DMV, costoPostSTR,
        costoService_STR,
        costoMaterialeFinale, isMatSTR, isNoIvaMat,
        totale3DMV, totaleSTR 
    };
  }

  function calcolaStandard() {
    saveState();
    renderPreventivo();
  }

  function calcolaTarget3DMV() {
      const dati = getDatiLordi();
      const t = parseNumberLoose(safeVal('target3DMV'));
      if(dati && t > 0 && dati.totale3DMV > 0) {
          const targetTot = t * dati.p;
          const sc = 100 - ((targetTot / dati.totale3DMV)*100);
          if(el('sconto3DMV')) el('sconto3DMV').value = sc.toFixed(2);
      }
      saveState();
      renderPreventivo();
  }

  function calcolaTargetSTR() {
      const dati = getDatiLordi();
      const t = parseNumberLoose(safeVal('targetSTR'));
      if(dati && t > 0 && dati.totaleSTR > 0) {
          const targetTot = t * dati.p;
          const sc = 100 - ((targetTot / dati.totaleSTR)*100);
          if(el('scontoSTR')) el('scontoSTR').value = sc.toFixed(2);
      }
      saveState();
      renderPreventivo();
  }

  function renderPreventivo() {
    // Uso safeVal qui dentro così non crasha se manca un campo
    const dati = getDatiLordi();
    if (!dati) {
      if(el('risultato')) el('risultato').innerHTML = '<p class="muted" style="text-align:center">Compila i dati...</p>';
      if(el('consuntivoTempi')) el('consuntivoTempi').style.display = 'none';
      return;
    }
    if(el('consuntivoTempi')) el('consuntivoTempi').style.display = 'block';

    const sconto3DMV = parseNumberLoose(safeVal('sconto3DMV'));
    const scontoSTR = parseNumberLoose(safeVal('scontoSTR'));

    // Calcolo Netti
    const importoSconto3DMV = dati.totale3DMV * (sconto3DMV / 100);
    const netto3DMV = dati.totale3DMV - importoSconto3DMV;

    const importoScontoSTR = dati.totaleSTR * (scontoSTR / 100);
    const nettoSTR = dati.totaleSTR - importoScontoSTR;

    const totaleNettoComplessivo = netto3DMV + nettoSTR;
    const costoPezzo = totaleNettoComplessivo / dati.p;

    // Unitari
    const unitario3DMV = netto3DMV / dati.p;
    const unitarioSTR = nettoSTR / dati.p;

    // Uso safeVal anche qui per evitare il crash 'TypeError: reading value of null'
    const noteRaw = el('note') ? el('note').value : '';
    const numPrev = el('numeroPreventivo') ? el('numeroPreventivo').value : '-';
    const codParte = el('codiceParte') ? el('codiceParte').value : '-';
    const matParte = el('materialeParte') ? el('materialeParte').value : '-';
    const ggConsegna = el('giorniConsegna') ? el('giorniConsegna').value : '-';

    if(el('consuntivoTempi')) el('consuntivoTempi').innerHTML = `
      <h3 style="margin-top:0">⏱️ Consuntivo Cluster (${dati.nStampanti} Macchine)</h3>
      <div class="row" style="gap:10px;">
        <div>Batch totali: <strong>${dati.batch}</strong></div>
        <div>Volume Stampa: <strong>${fmtNum.format(dati.oreTotaliVolume)} h</strong></div>
        <div>Durata (Velocità): <strong>${fmtNum.format(dati.oreCalendario)} h</strong> (${dati.g.toFixed(2)} gg)</div>
      </div>
    `;

    const dataOggi = new Date().toLocaleDateString('it-IT');
    
    if(el('risultato')) el('risultato').innerHTML = `
      <div class="preventivo-header">
         <div>
            ${CONFIG.LOGO_URL ? `<img src="${CONFIG.LOGO_URL}" style="height:60px; margin-bottom:10px; object-fit:contain;"><br>` : ''}
            <div style="font-size:24px; font-weight:bold; color:#0078d4">PREVENTIVO</div>
            <div class="muted">Rif: <strong>${escapeHtml(numPrev)}</strong> del ${dataOggi}</div>
         </div>
         <div style="text-align:right">
            <strong>${CONFIG.AZIENDA}</strong><br>
            <span class="muted">${CONFIG.EMAIL}</span>
         </div>
      </div>

      <div class="preventivo-box">
        <strong>Dettaglio Articolo</strong>
        <table class="prev-table">
            <colgroup>
               <col class="col-desc">
               <col class="col-value">
            </colgroup>
            <tr><td>Parte:</td><td>${escapeHtml(codParte)}</td></tr>
            <tr><td>Materiale:</td><td>${escapeHtml(matParte)}</td></tr>
            <tr><td>Quantità:</td><td><strong>${dati.p} pz</strong></td></tr>
            <tr><td>Consegna:</td><td>${ggConsegna} gg lavorativi</td></tr>
        </table>
      </div>

      <div class="preventivo-box">
        <strong>Dettaglio Costi</strong>
        <table class="prev-table">
            <colgroup>
               <col class="col-desc">
               <col class="col-value">
            </colgroup>
            
            <tr style="background:#e3f2fd; border-bottom:1px solid #bbdefb;">
                <td colspan="2" style="font-weight:bold; color:#0d47a1;">QUOTA 3DMV (Interno)</td>
            </tr>
            <tr><td style="padding-left:15px; font-size:13px;">• Cluster (${dati.nStampanti}x Macchine):</td><td align="right">${fmtMoney.format(dati.costoMacchine_3DMV)}</td></tr>
            <tr><td style="padding-left:15px; font-size:13px;">• Ricavo Gestione (Speed Premium):</td><td align="right">${fmtMoney.format(dati.costoRicavo_3DMV)}</td></tr>
            <tr><td style="padding-left:15px; font-size:13px;">• Post-Processo & Extra:</td><td align="right">${fmtMoney.format(dati.costoPost3DMV)}</td></tr>
            ${!dati.isMatSTR ? `<tr><td style="padding-left:15px; font-size:13px;">• Materiale:</td><td align="right">${fmtMoney.format(dati.costoMaterialeFinale)}</td></tr>` : ''}
            
            ${sconto3DMV !== 0 ? `
            <tr style="color:${sconto3DMV > 0 ? '#d32f2f' : '#2e7d32'};">
                <td align="right" style="padding-right:10px;">${sconto3DMV > 0 ? 'Sconto' : 'Ricarico'} (${sconto3DMV.toFixed(2)}%)</td><td align="right">${sconto3DMV > 0 ? '-' : '+'} ${fmtMoney.format(Math.abs(importoSconto3DMV))}</td>
            </tr>` : ''}
            
            <tr style="font-weight:bold; color:#0d47a1;">
                <td align="right">TOTALE QUOTA 3DMV:</td>
                <td align="right">
                    ${fmtMoney.format(netto3DMV)}<br>
                    <span style="font-size:11px; font-weight:normal; color:#555;">(Unitario: ${fmtMoney.format(unitario3DMV)})</span>
                </td>
            </tr>

            <tr><td colspan="2" style="height:15px;"></td></tr>
            <tr style="background:#e8f5e9; border-bottom:1px solid #c8e6c9;">
                <td colspan="2" style="font-weight:bold; color:#1b5e20;">QUOTA S.T.R. (Partner)</td>
            </tr>
            <tr><td style="padding-left:15px; font-size:13px;">• Gestione Commessa (Speed Premium):</td><td align="right">${fmtMoney.format(dati.costoService_STR)}</td></tr>
            <tr><td style="padding-left:15px; font-size:13px;">• Post-Processo & Extra:</td><td align="right">${fmtMoney.format(dati.costoPostSTR)}</td></tr>
            ${dati.isMatSTR ? `<tr><td style="padding-left:15px; font-size:13px;">• Materiale: ${dati.isNoIvaMat ? '<span style="color:#c62828; font-weight:bold;">(No IVA)</span>' : ''}</td><td align="right">${fmtMoney.format(dati.costoMaterialeFinale)}</td></tr>` : ''}
            
            ${scontoSTR !== 0 ? `
            <tr style="color:${scontoSTR > 0 ? '#d32f2f' : '#2e7d32'};">
                <td align="right" style="padding-right:10px;">${scontoSTR > 0 ? 'Sconto' : 'Ricarico'} (${scontoSTR.toFixed(2)}%)</td><td align="right">${scontoSTR > 0 ? '-' : '+'} ${fmtMoney.format(Math.abs(importoScontoSTR))}</td>
            </tr>` : ''}
            
            <tr style="font-weight:bold; color:#1b5e20;">
                <td align="right">TOTALE QUOTA S.T.R.:</td>
                <td align="right">
                    ${fmtMoney.format(nettoSTR)}<br>
                    <span style="font-size:11px; font-weight:normal; color:#555;">(Unitario: ${fmtMoney.format(unitarioSTR)})</span>
                </td>
            </tr>

            <tr><td colspan="2" style="height:15px; border-bottom:2px solid #333;"></td></tr>
            <tr style="font-weight:bold; font-size:18px;">
                <td>TOTALE FORNITURA</td><td align="right">${fmtMoney.format(totaleNettoComplessivo)}</td>
            </tr>
        </table>
      </div>

      <div class="total-block">
         <div class="muted">Prezzo unitario netto</div>
         <div style="font-size:18px;">${fmtMoney.format(costoPezzo)} / pz</div>
      </div>
      ${noteRaw ? `<div style="margin-top:20px; padding:10px; border:1px solid #eee; border-radius:6px;"><small><strong>NOTE:</strong><br>${escapeHtml(noteRaw).replaceAll('\n','<br>')}</small></div>` : ''}
    `;
  }

  async function init() {
    try {
        const res = await fetch('materiali.csv');
        if (!res.ok) throw new Error();
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(x => x.trim());
        const headers = lines[0].split(',').map(h => h.toLowerCase().trim());
        const idx = (n) => headers.findIndex(h => h.includes(n));
        const iId = idx('id'); const iNome = idx('nome'); const iCostoM = idx('costo-metri');
        if(iId >= 0 && iCostoM >= 0) {
            MATERIALI = lines.slice(1).map(line => {
                const c = line.split(',');
                return { id: c[iId], nome: c[iNome]||c[iId], costoMetri: parseNumberLoose(c[iCostoM]) };
            }).filter(x => x.id);
        } else throw new Error();
    } catch (e) {
        MATERIALI = CONFIG.FALLBACK_MATERIALS;
    }
    MATERIALI.forEach(m => MATERIALI_BY_ID[m.id] = m);
    for (let i = 1; i <= 4; i++) {
        const sel = el(`mat${i}`);
        if(sel) {
            sel.innerHTML = '<option value="">-- Seleziona --</option>';
            MATERIALI.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.nome} (€${m.costoMetri.toFixed(2)}/m)`;
                sel.appendChild(opt);
            });
        }
    }
    
    await loadConfigDefaults();
    loadState();

    if(el('checkMatSTR')) el('checkMatSTR').addEventListener('change', () => { toggleNoIvaBox(); calcolaStandard(); });
    if(el('checkNoIvaMat')) el('checkNoIvaMat').addEventListener('change', calcolaStandard);
    
    // Assegna listener solo se l'elemento esiste
    ['numStampanti','pezziTotali','pezziPerBatch','oreBatch','oreGiorno'].forEach(id => {
        if(el(id)) el(id).addEventListener('input', ricalcolaGiorniAuto);
    });

    inputsGeneric.forEach(inp => inp.addEventListener('input', calcolaStandard));
    if(el('target3DMV')) el('target3DMV').addEventListener('input', calcolaTarget3DMV);
    if(el('targetSTR')) el('targetSTR').addEventListener('input', calcolaTargetSTR);
    if(el('btnOttimizza')) el('btnOttimizza').addEventListener('click', ricalcolaGiorniAuto);
    if(el('btnPdf')) el('btnPdf').addEventListener('click', () => window.print());
    
    toggleNoIvaBox(); 
    ricalcolaGiorniAuto();
  }
  window.addEventListener('DOMContentLoaded', init);
</script>